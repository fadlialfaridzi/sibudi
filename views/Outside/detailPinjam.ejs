<%# =========================================================
    Detail Peminjaman Page - SiBuDi (Final Responsive Fix)
    ✅ Informasi Buku Sejajar dengan Navbar & Carousel
    ✅ Field otomatis tersembunyi jika kosong
    ✅ Efek mengambang & 3D tetap aktif
========================================================= %>

<%- include('../partials/header-simple.ejs', { title: title || 'Detail Peminjaman' }) %>

<body class="bg-gradient-to-br from-green-50 via-white to-yellow-50 font-['Inter'] min-h-screen">
  <%- include('../partials/navbarOutside.ejs') %>

  <main class="pt-20 pb-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl lg:text-4xl font-bold text-[#2F7A33] mb-2">
          <i class="fa-solid fa-book-open mr-2"></i> Detail Peminjaman Buku
        </h1>
        <p class="text-gray-600 text-sm md:text-base">
          Kelola perpanjangan dan lihat detail buku yang Anda pinjam
        </p>
      </div>

      <% if (loans && loans.length > 0) { %>
      
      <!-- Carousel Buku -->
      <div class="mb-10">
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-green-100">
          <h2 class="text-xl font-bold text-[#2F7A33] mb-6 flex items-center gap-2">
            <i class="fa-solid fa-layer-group"></i> Buku Dipinjam
            <span class="ml-auto bg-[#FFD700] text-[#2F7A33] px-3 py-1 rounded-full text-sm font-bold">
              <%= loans.length %>
            </span>
          </h2>

          <div class="carousel-3d-wrapper">
            <div class="carousel-3d-scene" id="carousel-3d-scene">
              <div class="carousel-3d-container" id="carousel-3d-container">
                <% loans.forEach((loan, index) => { %>
                <div class="carousel-3d-item <%= index === 0 ? 'active' : '' %>" 
                     data-index="<%= index %>"
                     style="--item-index: <%= index %>;">
                  
                  <div class="carousel-card">
                    <div class="carousel-reflection"></div>
                    <div class="carousel-card-inner">
                      <div class="carousel-image-wrapper">
                        <img src="<%= loan.image || '/images/buku.png' %>" 
                             alt="<%= loan.title %>" 
                             class="carousel-book-image">
                      </div>
                      <div class="carousel-info">
                        <h3 class="carousel-title"><%= loan.title || 'Tanpa Judul' %></h3>
                        <div class="carousel-meta">
                          <div class="meta-item">
                            <i class="fa-solid fa-barcode text-[#2F7A33]"></i>
                            <span><%= loan.item_code %></span>
                          </div>
                          <div class="meta-item">
                            <i class="fa-solid fa-calendar-check text-[#2F7A33]"></i>
                            <span><%= new Date(loan.loan_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }) %></span>
                          </div>
                          <div class="meta-item">
                            <i class="fa-solid fa-clock text-yellow-600"></i>
                            <% 
                              const days = loan.days_overdue || 0;
                              const color = days > 0 ? 'text-red-600' : 'text-green-600';
                            %>
                            <span class="<%= color %> font-semibold">
                              <%= days > 0 ? `${days} hari` : 'Tepat waktu' %>
                            </span>
                          </div>
                        </div>
                      </div>
                      <div class="carousel-badge">
                        <% if (loan.noReborrow) { %>
                          <span class="badge badge-gray"><i class="fa-solid fa-ban"></i> No Reborrow</span>
                        <% } else { %>
                          <span class="badge <%= loan.renewed >= loan.reborrow_limit ? 'badge-red' : 'badge-green' %>">
                            <i class="fa-solid fa-arrows-rotate"></i>
                            <%= loan.renewed || 0 %>/<%= loan.reborrow_limit || 2 %>
                          </span>
                        <% } %>
                      </div>
                    </div>
                    <div class="active-ring"></div>
                  </div>
                </div>
                <% }) %>
              </div>
            </div>

            <% if (loans.length > 1) { %>
            <button id="carousel-prev-3d" class="carousel-nav-btn carousel-nav-prev">
              <i class="fa-solid fa-chevron-left"></i>
            </button>
            <button id="carousel-next-3d" class="carousel-nav-btn carousel-nav-next">
              <i class="fa-solid fa-chevron-right"></i>
            </button>
            <div class="carousel-indicators">
              <% loans.forEach((loan, index) => { %>
                <button class="indicator <%= index === 0 ? 'active' : '' %>" data-index="<%= index %>"></button>
              <% }) %>
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Informasi Buku -->
      <div class="mb-10">
        <div id="book-info-card" 
             class="bg-white rounded-2xl shadow-lg border border-green-100 p-6 md:p-8 
                    max-w-7xl mx-auto transition-all duration-500 hover:shadow-xl">
          <h3 class="text-lg md:text-xl font-bold text-[#2F7A33] mb-6 flex items-center gap-2">
            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center">
              <i class="fa-solid fa-book text-green-600 text-base md:text-lg"></i>
            </div>
            <span>Informasi Buku</span>
          </h3>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
            <% const info = [
              { icon: 'fa-user-pen', color: 'bg-green-100 text-green-600', label: 'Penulis', value: loans[0].author },
              { icon: 'fa-calendar', color: 'bg-blue-100 text-blue-600', label: 'Tahun Terbit', value: loans[0].publish_year },
              { icon: 'fa-layer-group', color: 'bg-purple-100 text-purple-600', label: 'Jumlah Halaman', value: loans[0].collation_pages ? loans[0].collation_pages + ' Halaman' : null },
              { icon: 'fa-ruler-combined', color: 'bg-yellow-100 text-yellow-600', label: 'Ketebalan Buku', value: loans[0].collation_size },
              { icon: 'fa-language', color: 'bg-indigo-100 text-indigo-600', label: 'Bahasa', value: loans[0].language },
              { icon: 'fa-building', color: 'bg-pink-100 text-pink-600', label: 'Penerbit', value: loans[0].publisher },
              { icon: 'fa-bookmark', color: 'bg-teal-100 text-teal-600', label: 'Jenis Koleksi', value: loans[0].coll_type },
              { icon: 'fa-location-dot', color: 'bg-orange-100 text-orange-600', label: 'Lokasi', value: loans[0].location },
            ]; %>

            <% info.filter(i => i.value && i.value.trim() !== '').forEach(i => { %>
              <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100 hover:bg-green-50 transition">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center <%= i.color.split(' ')[0] %>">
                  <i class="fa-solid <%= i.icon %> <%= i.color.split(' ')[1] %> text-sm"></i>
                </div>
                <div class="flex-1">
                  <p class="text-xs text-gray-500 uppercase font-semibold"><%= i.label %></p>
                  <p class="text-sm md:text-base font-bold text-gray-800"><%= i.value %></p>
                </div>
              </div>
            <% }) %>

            <% if (info.filter(i => i.value && i.value.trim() !== '').length === 0) { %>
              <p class="col-span-full text-center text-gray-500 italic text-sm">
                Tidak ada informasi buku yang tersedia.
              </p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Detail Pinjaman Dynamic (Dari main.js) -->
      <div id="book-detail" class="space-y-6"></div>

      <!-- Hidden JSON -->
      <script type="application/json" id="loans-data">
        <%- JSON.stringify(loans) %>
      </script>
      <input type="hidden" id="total-denda" value="<%= totalDenda || 0 %>">

      <% } else { %>
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-10 text-center border border-gray-200">
          <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center">
            <i class="fa-solid fa-book-open text-4xl text-gray-400"></i>
          </div>
          <h2 class="text-xl font-bold text-gray-800 mb-3">Belum Ada Peminjaman Aktif</h2>
          <p class="text-gray-600 mb-6">Anda belum memiliki buku yang sedang dipinjam. Kunjungi katalog untuk meminjam buku.</p>
          <a href="/outside/dashboard" class="inline-flex items-center gap-2 px-6 py-3 bg-[#2F7A33] text-white rounded-xl font-semibold hover:bg-[#256328] transition">
            <i class="fa-solid fa-home"></i> Kembali ke Dashboard
          </a>
        </div>
      <% } %>

    </div>
  </main>

  <!-- Link Animasi -->
  <link rel="stylesheet" href="/css/animasi3d.css">
  <link rel="stylesheet" href="/css/carousel.css">
  <script src="/js/main.js"></script>
  <script src="/js/carousel.js"></script>
</body>
