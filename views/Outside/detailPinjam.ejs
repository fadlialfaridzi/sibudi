<%# =========================================================
    Detail Peminjaman Page - SiBuDi (Final Complete)
    ✅ Urutan: List Buku → Info Buku → Aturan → Status+Perpanjangan/Denda
    ✅ 2 Kondisi: Ada denda = Section Denda, Tidak ada denda = Section Perpanjangan
========================================================= %>

<%- include('../partials/header-simple.ejs', { title: title || 'Detail Peminjaman' }) %>

<body class="bg-gradient-to-br from-green-50 via-white to-yellow-50 font-['Inter'] min-h-screen">
  <%- include('../partials/navbarOutside.ejs') %>

  <main class="pt-20 pb-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl lg:text-4xl font-bold text-[#2F7A33] mb-2">
          <i class="fa-solid fa-book-open mr-2"></i> Detail Peminjaman Buku
        </h1>
        <p class="text-gray-600 text-sm md:text-base">
          Kelola perpanjangan dan lihat detail buku yang Anda pinjam
        </p>
      </div>

      <% if (loans && loans.length > 0) { %>
      
      <!-- 1️⃣ LIST BUKU YANG DIPINJAM (Carousel 3D - JANGAN DIUBAH) -->
      <div class="mb-10">
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-green-100 overflow-hidden">
          <h2 class="text-xl font-bold text-[#2F7A33] mb-6 flex items-center gap-2">
            <i class="fa-solid fa-layer-group"></i> List Buku Yang Dipinjam
            <span class="ml-auto bg-[#FFD700] text-[#2F7A33] px-3 py-1 rounded-full text-sm font-bold">
              <%= loans.length %>
            </span>
          </h2>

          <div class="relative w-full flex flex-col items-center">
            <div class="carousel-3d-wrapper w-full max-w-5xl mx-auto">
              <div class="carousel-3d-scene overflow-hidden">
                <div
                  class="carousel-3d-container flex gap-8 items-stretch justify-center transition-transform duration-700 ease-in-out"
                  id="carousel-3d-container"
                >
                  <% loans.forEach((loan, index) => { %>
                  <div
                    class="carousel-3d-item flex-shrink-0 w-64 sm:w-72 md:w-80 lg:w-96 transition-all duration-500 transform hover:scale-[1.02] cursor-pointer"
                    data-index="<%= index %>"
                    onclick="selectBook('<%= index %>')"
                  >
                    <div
                      class="carousel-card flex flex-col bg-gradient-to-br from-white to-green-50 shadow-md rounded-2xl border <%= index === 0 ? 'border-[#2F7A33] ring-2 ring-[#2F7A33]' : 'border-green-100' %> h-full overflow-hidden hover:shadow-xl transition-all"
                    >
                      <div class="relative w-full h-56 sm:h-64 md:h-72 overflow-hidden">
                        <img
                          src="<%= loan.image || '/images/buku.png' %>"
                          alt="<%= loan.title %>"
                          class="object-contain w-full h-full p-4"
                        />
                      </div>

                      <div class="p-5 flex-1 flex flex-col justify-between">
                        <div>
                          <h3 class="text-lg font-bold text-[#2F7A33] mb-3 text-center line-clamp-2">
                            <%= loan.title || 'Tanpa Judul' %>
                          </h3>
                          <div class="space-y-2 text-sm text-gray-700">
                            <div class="flex items-center gap-2">
                              <i class="fa-solid fa-barcode text-[#2F7A33] w-5"></i>
                              <span><%= loan.item_code %></span>
                            </div>
                            <div class="flex items-center gap-2">
                              <i class="fa-solid fa-calendar-check text-[#2F7A33] w-5"></i>
                              <span>
                                <%= new Date(loan.loan_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }) %>
                              </span>
                            </div>
                            <div class="flex items-center gap-2">
                              <i class="fa-solid fa-clock text-yellow-600 w-5"></i>
                              <% 
                              const workingDaysOverdue = loan.days_overdue || 0;
                              const today = new Date();
                              const dueDate = new Date(loan.due_date);
                              
                              // Hitung sisa hari (bisa negatif jika terlambat)
                              const diffTime = dueDate - today;
                              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                              
                              let statusText = '';
                              let daysColor = '';
                              
                              if (workingDaysOverdue > 0) {
                                // Terlambat
                                statusText = `Terlambat ${workingDaysOverdue} hari`;
                                daysColor = 'text-red-600';
                              } else if (diffDays > 0) {
                                // Masih ada waktu
                                statusText = `Sisa ${diffDays} hari`;
                                daysColor = 'text-green-600';
                              } else if (diffDays === 0) {
                                // Hari ini deadline
                                statusText = 'Deadline hari ini';
                                daysColor = 'text-yellow-600';
                              } else {
                                // Tepat waktu
                                statusText = 'Tepat waktu';
                                daysColor = 'text-green-600';
                              }
                              %>
                              <span class="<%= daysColor %> font-semibold"><%= statusText %></span>
                            </div>
                          </div>
                        </div>

                        <div class="mt-4 flex justify-center">
                          <% if (loan.noReborrow) { %>
                            <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-semibold">
                              <i class="fa-solid fa-ban"></i> Tidak Dapat Diperpanjang
                            </span>
                          <% } else { %>
                            <span class="<%= loan.renewed >= loan.reborrow_limit ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700' %> px-3 py-1 rounded-full text-xs font-semibold">
                              <i class="fa-solid fa-arrows-rotate"></i>
                              <%= loan.renewed || 0 %>/<%= loan.reborrow_limit || 2 %>
                            </span>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>
            </div>

            <% if (loans.length > 1) { %>
            <div class="flex items-center justify-center mt-6 gap-4">
              <button
                id="carousel-prev-3d"
                class="p-3 rounded-full bg-[#2F7A33] text-white hover:bg-[#256328] transition"
              >
                <i class="fa-solid fa-chevron-left"></i>
              </button>
              <button
                id="carousel-next-3d"
                class="p-3 rounded-full bg-[#2F7A33] text-white hover:bg-[#256328] transition"
              >
                <i class="fa-solid fa-chevron-right"></i>
              </button>
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- 2️⃣ INFORMASI BUKU -->
      <div class="mb-10">
        <div id="book-info-card" 
             class="card-3d bg-white rounded-2xl shadow-lg border border-green-100 p-6 md:p-8 
                    max-w-7xl mx-auto transition-all duration-500 hover:shadow-xl">
          <h3 class="text-lg md:text-xl font-bold text-[#2F7A33] mb-6 flex items-center gap-2">
            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center">
              <i class="fa-solid fa-book text-green-600 text-base md:text-lg"></i>
            </div>
            <span>Informasi Buku</span>
          </h3>

          <div id="book-info-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Will be dynamically updated by JavaScript -->
            <% 
            const currentBook = loans[0];
            const infoItems = [
              { icon: 'fa-user-pen', color: 'bg-green-100 text-green-600', label: 'Penulis', value: currentBook.author },
              { icon: 'fa-calendar', color: 'bg-blue-100 text-blue-600', label: 'Tahun Terbit', value: currentBook.publish_year },
              { icon: 'fa-layer-group', color: 'bg-purple-100 text-purple-600', label: 'Jumlah Halaman', value: currentBook.collation_pages },
              { icon: 'fa-ruler-combined', color: 'bg-yellow-100 text-yellow-600', label: 'Ketebalan Buku', value: currentBook.collation_size },
              { icon: 'fa-language', color: 'bg-indigo-100 text-indigo-600', label: 'Bahasa', value: currentBook.language },
              { icon: 'fa-building', color: 'bg-pink-100 text-pink-600', label: 'Penerbit', value: currentBook.publisher },
              { icon: 'fa-bookmark', color: 'bg-teal-100 text-teal-600', label: 'Jenis Koleksi', value: currentBook.coll_type },
              { icon: 'fa-location-dot', color: 'bg-orange-100 text-orange-600', label: 'Lokasi', value: currentBook.location }
            ]; 
            %>

            <% infoItems.filter(function(i) { return i.value && i.value.trim() !== ''; }).forEach(function(i) { %>
              <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100 hover:bg-green-50 transition">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center <%= i.color.split(' ')[0] %>">
                  <i class="fa-solid <%= i.icon %> <%= i.color.split(' ')[1] %> text-sm"></i>
                </div>
                <div class="flex-1">
                  <p class="text-xs text-gray-500 uppercase font-semibold"><%= i.label %></p>
                  <p class="text-sm md:text-base font-bold text-gray-800"><%= i.value %></p>
                </div>
              </div>
            <% }); %>

            <% if (infoItems.filter(function(i) { return i.value && i.value.trim() !== ''; }).length === 0) { %>
              <p class="col-span-full text-center text-gray-500 italic text-sm">
                Tidak ada informasi buku yang tersedia.
              </p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- 3️⃣ ATURAN PEMINJAMAN -->
      <div class="mb-10">
        <div class="card-3d bg-white rounded-2xl shadow-lg border border-yellow-100 p-6 md:p-8 max-w-7xl mx-auto transition-all duration-500 hover:shadow-xl">
          <h3 class="text-lg md:text-xl font-bold text-[#2F7A33] mb-6 flex items-center gap-2">
            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-yellow-100 flex items-center justify-center">
              <i class="fa-solid fa-circle-info text-yellow-600 text-base md:text-lg"></i>
            </div>
            <span>Aturan Peminjaman</span>
          </h3>

          <% const currentLoan = loans[0]; %>
          
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200">
              <div class="flex justify-center mb-2">
                <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center">
                  <i class="fa-solid fa-clock text-xl"></i>
                </div>
              </div>
              <p class="text-xs text-gray-600 uppercase mb-1 font-semibold">Durasi Peminjaman</p>
              <p class="text-2xl font-bold text-gray-800"><%= currentLoan.loan_periode || 7 %> hari kerja</p>
            </div>

            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border border-green-200">
              <div class="flex justify-center mb-2">
                <div class="w-12 h-12 rounded-full bg-green-500 text-white flex items-center justify-center">
                  <i class="fa-solid fa-arrows-rotate text-xl"></i>
                </div>
              </div>
              <p class="text-xs text-gray-600 uppercase mb-1 font-semibold">Batas Perpanjangan</p>
              <p class="text-2xl font-bold text-gray-800"><%= currentLoan.reborrow_limit || 2 %> kali</p>
            </div>

            <div class="text-center p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-xl border border-red-200">
              <div class="flex justify-center mb-2">
                <div class="w-12 h-12 rounded-full bg-red-500 text-white flex items-center justify-center">
                  <i class="fa-solid fa-money-bill text-xl"></i>
                </div>
              </div>
              <p class="text-xs text-gray-600 uppercase mb-1 font-semibold">Denda per Hari</p>
              <p class="text-2xl font-bold text-gray-800">Rp <%= Number(currentLoan.fine_per_day || 1000).toLocaleString('id-ID') %></p>
            </div>
          </div>

          <!-- Info Tambahan Perhitungan Denda -->
          <div class="flex items-start gap-3 p-4 bg-gradient-to-r from-red-50 to-orange-50 rounded-xl border-2 border-red-200">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                <i class="fa-solid fa-exclamation-triangle text-red-600 text-lg"></i>
              </div>
            </div>
            <div class="flex-1">
              <p class="text-sm font-bold text-red-700 mb-1">Penting!</p>
              <p class="text-xs text-red-600">
                Perhitungan denda dimulai <b>sehari setelah deadline pengembalian buku</b>. 
                Denda hanya dihitung pada <b>hari kerja</b> (Senin-Sabtu, kecuali hari libur nasional).
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- 4️⃣ STATUS PEMINJAMAN + PERPANJANGAN / DENDA -->
      <% if (totalDenda && totalDenda > 0) { %>
        <!-- KONDISI 1: ADA DENDA - Section Perpanjangan Dihapus, Diganti Section Denda -->
        <div class="mb-10">
          <!-- Status Peminjaman -->
          <div class="card-3d bg-white rounded-2xl shadow-lg border border-blue-100 p-6 md:p-8 mb-6 max-w-7xl mx-auto">
            <h3 class="text-lg md:text-xl font-bold text-[#2F7A33] mb-6 flex items-center gap-2">
              <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fa-solid fa-clipboard-list text-blue-600 text-base md:text-lg"></i>
              </div>
              <span>Status Peminjaman</span>
            </h3>

            <div id="status-peminjaman" class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 rounded-xl bg-gradient-to-br from-green-50 to-green-100 border border-green-200">
                <div class="flex items-center gap-3 mb-2">
                  <i class="fa-solid fa-calendar-check text-green-600 text-xl"></i>
                  <span class="text-sm text-gray-600 font-semibold">Tanggal Pinjam</span>
                </div>
                <p class="font-bold text-gray-800 text-lg">
                  <%= new Date(currentLoan.loan_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) %>
                </p>
              </div>

              <div class="p-4 rounded-xl bg-gradient-to-br from-red-50 to-red-100 border border-red-200">
                <div class="flex items-center gap-3 mb-2">
                  <i class="fa-solid fa-calendar-xmark text-red-600 text-xl"></i>
                  <span class="text-sm text-gray-600 font-semibold">Deadline Pengembalian</span>
                </div>
                <p class="font-bold text-gray-800 text-lg">
                  <%= new Date(currentLoan.due_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) %>
                </p>
              </div>
            </div>

            <% if (!currentLoan.noReborrow) { %>
            <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-xl">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center">
                  <i class="fa-solid fa-arrows-rotate text-xl"></i>
                </div>
                <div class="flex-1">
                  <p class="text-sm text-gray-600 font-semibold">Status Perpanjangan</p>
                  <p class="text-lg font-bold <%= currentLoan.renewed >= currentLoan.reborrow_limit ? 'text-red-600' : 'text-green-600' %>">
                    <%= currentLoan.renewed || 0 %> dari <%= currentLoan.reborrow_limit || 2 %> kali
                  </p>
                </div>
              </div>
            </div>
            <% } %>
          </div>

          <!-- Section Denda (Menggantikan Section Perpanjangan) -->
          <div class="card-3d bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl shadow-lg border-2 border-red-300 p-6 md:p-8 max-w-7xl mx-auto">
            <h3 class="text-lg md:text-xl font-bold text-red-700 mb-6 flex items-center gap-2">
              <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-red-100 flex items-center justify-center">
                <i class="fa-solid fa-exclamation-triangle text-red-600 text-base md:text-lg"></i>
              </div>
              <span>Informasi Denda</span>
            </h3>

            <div class="bg-white rounded-xl p-6 border-2 border-red-200 mb-6">
              <div class="text-center">
                <p class="text-sm text-gray-600 mb-2 font-semibold">Total Denda Aktif</p>
                <p class="text-4xl md:text-5xl font-bold text-red-600">Rp <%= totalDenda.toLocaleString('id-ID') %></p>
              </div>
            </div>

            <div class="p-5 bg-red-100 rounded-xl border-2 border-red-300">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-circle-exclamation text-red-600 text-2xl mt-1"></i>
                <div>
                  <p class="font-bold text-red-700 mb-2 text-base">Anda memiliki denda aktif!</p>
                  <p class="text-sm text-red-600">
                    Harap lunasi denda terlebih dahulu sebelum melakukan perpanjangan atau peminjaman baru. 
                    Silakan hubungi pustakawan untuk proses pembayaran denda.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

      <% } else { %>
        <!-- KONDISI 2: TIDAK ADA DENDA - Section Perpanjangan Normal -->
        <div class="mb-10">
          <div class="card-3d bg-white rounded-2xl shadow-lg border border-green-100 p-6 md:p-8 max-w-7xl mx-auto">
            <h3 class="text-lg md:text-xl font-bold text-[#2F7A33] mb-6 flex items-center gap-2">
              <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fa-solid fa-clipboard-list text-blue-600 text-base md:text-lg"></i>
              </div>
              <span>Status Peminjaman</span>
            </h3>

            <div id="status-peminjaman" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div class="p-4 rounded-xl bg-gradient-to-br from-green-50 to-green-100 border border-green-200">
                <div class="flex items-center gap-3 mb-2">
                  <i class="fa-solid fa-calendar-check text-green-600 text-xl"></i>
                  <span class="text-sm text-gray-600 font-semibold">Tanggal Pinjam</span>
                </div>
                <p class="font-bold text-gray-800 text-lg">
                  <%= new Date(currentLoan.loan_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) %>
                </p>
              </div>

              <div class="p-4 rounded-xl bg-gradient-to-br from-red-50 to-red-100 border border-red-200">
                <div class="flex items-center gap-3 mb-2">
                  <i class="fa-solid fa-calendar-xmark text-red-600 text-xl"></i>
                  <span class="text-sm text-gray-600 font-semibold">Deadline Pengembalian</span>
                </div>
                <p class="font-bold text-gray-800 text-lg">
                  <%= new Date(currentLoan.due_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) %>
                </p>
              </div>
            </div>

            <% if (!currentLoan.noReborrow) { %>
            <div class="p-4 bg-green-50 border border-green-200 rounded-xl mb-6">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center">
                  <i class="fa-solid fa-arrows-rotate text-xl"></i>
                </div>
                <div class="flex-1">
                  <p class="text-sm text-gray-600 font-semibold">Status Perpanjangan</p>
                  <p class="text-lg font-bold <%= currentLoan.renewed >= currentLoan.reborrow_limit ? 'text-red-600' : 'text-green-600' %>">
                    <%= currentLoan.renewed || 0 %> dari <%= currentLoan.reborrow_limit || 2 %> kali
                  </p>
                </div>
                <% if (currentLoan.renewed >= currentLoan.reborrow_limit) { %>
                <span class="text-xs font-semibold text-red-600 bg-red-100 px-3 py-1 rounded-full">Maksimal</span>
                <% } %>
              </div>
            </div>
            <% } %>

            <!-- Aksi Perpanjangan -->
            <div id="perpanjangan-section">
              <h4 class="text-base font-bold text-[#2F7A33] mb-4 flex items-center gap-2">
                <i class="fa-solid fa-arrows-rotate"></i>
                <span>Aksi Perpanjangan</span>
              </h4>

              <% 
              let disabledReason = null;
              let warningType = "warning";
              
              if (currentLoan.noReborrow) {
                disabledReason = "Jenis koleksi ini tidak dapat diperpanjang sesuai kebijakan perpustakaan.";
                warningType = "info";
              } else if (currentLoan.renewed >= currentLoan.reborrow_limit) {
                disabledReason = `Anda sudah mencapai batas maksimal perpanjangan (<b>${currentLoan.reborrow_limit}x</b>).`;
                warningType = "warning";
              }
              %>

              <% if (disabledReason) { %>
                <% 
                let bgColor, borderColor, iconColor, textColor, icon;
                
                if (warningType === "info") {
                  bgColor = "from-gray-50 to-blue-50";
                  borderColor = "border-gray-300";
                  iconColor = "bg-gray-200 text-gray-600";
                  textColor = "text-gray-700";
                  icon = "fa-info-circle";
                } else {
                  bgColor = "from-yellow-50 to-orange-50";
                  borderColor = "border-orange-200";
                  iconColor = "bg-orange-100 text-orange-600";
                  textColor = "text-orange-700";
                  icon = "fa-triangle-exclamation";
                }
                %>

                <div class="bg-gradient-to-br <%= bgColor %> <%= textColor %> border-2 <%= borderColor %> rounded-xl p-4 mb-4">
                  <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full <%= iconColor %> flex items-center justify-center">
                      <i class="fa-solid <%= icon %> text-lg"></i>
                    </div>
                    <div class="flex-1">
                      <p class="font-semibold mb-1"><%- disabledReason %></p>
                      <p class="text-xs opacity-80">
                        <%= currentLoan.noReborrow ? "Silakan hubungi pustakawan untuk informasi lebih lanjut mengenai aturan koleksi ini." : "Silakan konfirmasi ke pustakawan untuk informasi lebih lanjut." %>
                      </p>
                    </div>
                  </div>
                </div>
              <% } %>

              <form method="POST" action="/outside/extend" class="w-full">
                <input type="hidden" name="loan_id" value="<%= currentLoan.loan_id %>">
                <button 
                  type="submit"
                  <%= disabledReason ? 'disabled' : '' %>
                  class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-6 py-4 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2 <%= disabledReason ? 'opacity-50 cursor-not-allowed grayscale' : '' %>"
                >
                  <i class="fa-solid fa-arrows-rotate"></i> Perpanjang Buku Ini
                </button>
              </form>
            </div>
          </div>
        </div>
      <% } %>

      <!-- Hidden JSON -->
      <script type="application/json" id="loans-data">
        <%- JSON.stringify(loans) %>
      </script>
      <input type="hidden" id="total-denda" value="<%= totalDenda || 0 %>">

      <% } else { %>
        <!-- Empty State -->
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-10 text-center border border-gray-200">
          <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center">
            <i class="fa-solid fa-book-open text-4xl text-gray-400"></i>
          </div>
          <h2 class="text-xl font-bold text-gray-800 mb-3">Belum Ada Peminjaman Aktif</h2>
          <p class="text-gray-600 mb-6">Anda belum memiliki buku yang sedang dipinjam. Kunjungi katalog untuk meminjam buku.</p>
          <a href="/outside/dashboard" class="inline-flex items-center gap-2 px-6 py-3 bg-[#2F7A33] text-white rounded-xl font-semibold hover:bg-[#256328] transition">
            <i class="fa-solid fa-home"></i> Kembali ke Dashboard
          </a>
        </div>
      <% } %>

    </div>
  </main>

  <!-- Popup Notification -->
  <% if (popup) { %>
  <div id="popup-notification" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fadeIn">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden transform animate-slideUp">
      <div class="p-6">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center <%= popup.type === 'success' ? 'bg-green-100' : popup.type === 'error' ? 'bg-red-100' : 'bg-yellow-100' %>">
            <i class="fa-solid <%= popup.type === 'success' ? 'fa-circle-check text-green-600' : popup.type === 'error' ? 'fa-circle-xmark text-red-600' : 'fa-triangle-exclamation text-yellow-600' %> text-2xl"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-2"><%= popup.title %></h3>
            <p class="text-gray-600 text-sm"><%- popup.message %></p>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closePopup()" class="px-6 py-2 bg-[#2F7A33] text-white rounded-lg font-semibold hover:bg-[#256328] transition-colors">
          Tutup
        </button>
      </div>
    </div>
  </div>

  <script>
    function closePopup() {
      const popup = document.getElementById('popup-notification');
      popup?.classList.add('animate-fadeOut');
      setTimeout(() => popup?.remove(), 300);
    }
    setTimeout(closePopup, 5000);
  </script>
  <% } %>

  <!-- Link Animasi -->
  <link rel="stylesheet" href="/css/animasi3d.css">
  <link rel="stylesheet" href="/css/carousel.css">

  <style>
    /* Line clamp for title */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 2;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeOut {
      to { opacity: 0; }
    }

    .animate-fadeIn { animation: fadeIn 0.3s ease; }
    .animate-slideUp { animation: slideUp 0.4s ease; }
    .animate-fadeOut { animation: fadeOut 0.3s ease; }

    /* Card active border on carousel */
    .carousel-card {
      transition: all 0.3s ease;
    }
  </style>

  <!-- JavaScript -->
  <script>
    // =====================================================
    // Global Variables
    // =====================================================
    let currentBookIndex = 0;
    let loansData = [];

    // =====================================================
    // Initialize on Load
    // =====================================================
    document.addEventListener('DOMContentLoaded', function() {
      // Load loans data
      const loansDataEl = document.querySelector("#loans-data");
      if (loansDataEl) {
        try {
          loansData = JSON.parse(loansDataEl.textContent || "[]");
          console.log('📚 Loaded loans data:', loansData);
          
          // Initialize first book
          if (loansData.length > 0) {
            selectBook(0);
          }
        } catch (err) {
          console.error('❌ Error loading loans data:', err);
        }
      }

      // Add transition styles
      const infoGrid = document.getElementById('book-info-grid');
      const statusSection = document.getElementById('status-peminjaman');
      
      if (infoGrid) {
        infoGrid.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      }
      if (statusSection) {
        statusSection.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      }
    });

    // =====================================================
    // Select Book Function (Update Info Buku & Status)
    // =====================================================
    function selectBook(index) {
      console.log('📖 Selecting book:', index);
      currentBookIndex = index;
      
      try {
        const selectedBook = loansData[index];
        
        if (!selectedBook) {
          console.error('Book not found at index:', index);
          return;
        }

        // Update active state pada carousel
        document.querySelectorAll('.carousel-3d-item .carousel-card').forEach(function(card, idx) {
          if (idx === index) {
            card.classList.add('border-[#2F7A33]', 'ring-2', 'ring-[#2F7A33]');
            card.classList.remove('border-green-100');
          } else {
            card.classList.remove('border-[#2F7A33]', 'ring-2', 'ring-[#2F7A33]');
            card.classList.add('border-green-100');
          }
        });

        // Update Informasi Buku
        updateBookInfo(selectedBook);
        
        // Update Status Peminjaman
        updateStatusPeminjaman(selectedBook);
        
        // Update Aturan Peminjaman
        updateAturanPeminjaman(selectedBook);
        
        // Update Form Perpanjangan
        updatePerpanjanganForm(selectedBook);

      } catch (err) {
        console.error('❌ Error selecting book:', err);
      }
    }

    // =====================================================
    // Update Informasi Buku
    // =====================================================
    function updateBookInfo(book) {
      const infoGrid = document.getElementById('book-info-grid');
      if (!infoGrid) return;

      const infoItems = [
        { icon: 'fa-user-pen', color: 'bg-green-100 text-green-600', label: 'Penulis', value: book.author },
        { icon: 'fa-calendar', color: 'bg-blue-100 text-blue-600', label: 'Tahun Terbit', value: book.publish_year },
        { icon: 'fa-layer-group', color: 'bg-purple-100 text-purple-600', label: 'Jumlah Halaman', value: book.collation_pages },
        { icon: 'fa-ruler-combined', color: 'bg-yellow-100 text-yellow-600', label: 'Ketebalan Buku', value: book.collation_size },
        { icon: 'fa-language', color: 'bg-indigo-100 text-indigo-600', label: 'Bahasa', value: book.language },
        { icon: 'fa-building', color: 'bg-pink-100 text-pink-600', label: 'Penerbit', value: book.publisher },
        { icon: 'fa-bookmark', color: 'bg-teal-100 text-teal-600', label: 'Jenis Koleksi', value: book.coll_type },
        { icon: 'fa-location-dot', color: 'bg-orange-100 text-orange-600', label: 'Lokasi', value: book.location }
      ].filter(function(i) { return i.value && i.value.toString().trim() !== ''; });

      // Fade out
      infoGrid.style.opacity = '0';
      infoGrid.style.transform = 'translateY(10px)';

      setTimeout(function() {
        if (infoItems.length === 0) {
          infoGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 italic text-sm">Tidak ada informasi buku yang tersedia.</p>';
        } else {
          infoGrid.innerHTML = infoItems.map(function(i) {
            return '<div class="flex items-start gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100 hover:bg-green-50 transition">' +
              '<div class="w-10 h-10 rounded-lg flex items-center justify-center ' + i.color.split(' ')[0] + '">' +
                '<i class="fa-solid ' + i.icon + ' ' + i.color.split(' ')[1] + ' text-sm"></i>' +
              '</div>' +
              '<div class="flex-1">' +
                '<p class="text-xs text-gray-500 uppercase font-semibold">' + i.label + '</p>' +
                '<p class="text-sm md:text-base font-bold text-gray-800">' + i.value + '</p>' +
              '</div>' +
            '</div>';
          }).join('');
        }

        // Fade in
        setTimeout(function() {
          infoGrid.style.opacity = '1';
          infoGrid.style.transform = 'translateY(0)';
        }, 50);
      }, 300);
    }

    // =====================================================
    // Update Status Peminjaman
    // =====================================================
    function updateStatusPeminjaman(book) {
      const statusSection = document.getElementById('status-peminjaman');
      if (!statusSection) return;

      const loanDate = new Date(book.loan_date).toLocaleDateString('id-ID', { 
        day: '2-digit', month: 'long', year: 'numeric' 
      });
      const dueDate = new Date(book.due_date).toLocaleDateString('id-ID', { 
        day: '2-digit', month: 'long', year: 'numeric' 
      });

      // Fade out
      statusSection.style.opacity = '0';
      statusSection.style.transform = 'translateY(10px)';

      setTimeout(function() {
        statusSection.innerHTML = 
          '<div class="p-4 rounded-xl bg-gradient-to-br from-green-50 to-green-100 border border-green-200">' +
            '<div class="flex items-center gap-3 mb-2">' +
              '<i class="fa-solid fa-calendar-check text-green-600 text-xl"></i>' +
              '<span class="text-sm text-gray-600 font-semibold">Tanggal Pinjam</span>' +
            '</div>' +
            '<p class="font-bold text-gray-800 text-lg">' + loanDate + '</p>' +
          '</div>' +
          '<div class="p-4 rounded-xl bg-gradient-to-br from-red-50 to-red-100 border border-red-200">' +
            '<div class="flex items-center gap-3 mb-2">' +
              '<i class="fa-solid fa-calendar-xmark text-red-600 text-xl"></i>' +
              '<span class="text-sm text-gray-600 font-semibold">Deadline Pengembalian</span>' +
            '</div>' +
            '<p class="font-bold text-gray-800 text-lg">' + dueDate + '</p>' +
          '</div>';

        // Fade in
        setTimeout(function() {
          statusSection.style.opacity = '1';
          statusSection.style.transform = 'translateY(0)';
        }, 50);
      }, 300);
    }

    // =====================================================
    // Update Aturan Peminjaman
    // =====================================================
    function updateAturanPeminjaman(book) {
      // Aturan peminjaman static, tidak perlu update
      // Tapi bisa diupdate jika berbeda per buku
    }

    // =====================================================
    // Update Form Perpanjangan
    // =====================================================
    function updatePerpanjanganForm(book) {
      const perpanjanganForm = document.querySelector('#perpanjangan-section form input[name="loan_id"]');
      if (perpanjanganForm) {
        perpanjanganForm.value = book.loan_id;
        console.log('✅ Updated loan_id to:', book.loan_id);
      }
    }

    // =====================================================
    // Responsive Font untuk Judul Buku
    // =====================================================
    function adjustTitleFontSize() {
      if (window.innerWidth <= 768) {
        document.querySelectorAll('.line-clamp-2').forEach(function(title) {
          const lineHeight = parseFloat(getComputedStyle(title).lineHeight);
          const maxHeight = lineHeight * 2;
          if (title.scrollHeight > maxHeight) {
            title.style.fontSize = '0.875rem';
          }
        });
      }
    }
    adjustTitleFontSize();
    window.addEventListener('resize', adjustTitleFontSize);

    // =====================================================
    // 3D Tilt Effect
    // =====================================================
    document.querySelectorAll(".card-3d").forEach(function(el) {
      el.addEventListener("mousemove", function(e) {
        const rect = el.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const rotateX = ((y - rect.height / 2) / 25) * -1;
        const rotateY = (x - rect.width / 2) / 25;
        el.style.setProperty("--rotateX", rotateX + "deg");
        el.style.setProperty("--rotateY", rotateY + "deg");
      });
      el.addEventListener("mouseleave", function() {
        el.style.setProperty("--rotateX", "0deg");
        el.style.setProperty("--rotateY", "0deg");
      });
    });
  </script>

  <script src="/js/main.js"></script>
  <script src="/js/carousel.js"></script>
  <script>
    // =====================================================
    // (A) ALIAS FUNGSI untuk carousel.js
    // =====================================================
    if (typeof window !== 'undefined' && typeof selectBook === 'function') {
      window.showDetail = selectBook;
    }
    if (typeof window !== 'undefined' && typeof loansData !== 'undefined') {
      window.loansData = loansData;
    }
  
    // =====================================================
    // (B) CEGAH AUTO-SUBMIT FORM PERPANJANGAN
    // =====================================================
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('#perpanjangan-section form').forEach(form => {
        form.addEventListener('submit', function(e) {
          if (!e.isTrusted) {
            e.preventDefault();
            console.warn('Programmatic submit blocked for debugging.');
          }
        }, true);
      });
    });
  </script>

</body>
</html>