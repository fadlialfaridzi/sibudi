<%- include('../partials/header-simple', { title: 'Mode Kios - Peminjaman Buku | SiBuDi' }) %>

<body class="min-h-screen" style="background: linear-gradient(135deg, #F0F8F0 0%, #E8F5E9 100%); font-family: 'Inter', sans-serif;">

  <!-- Navbar -->
  <%- include('../partials/navbarInside', { activeNav: 'Peminjaman' }) %>

  <!-- Main Content (with top padding for fixed navbar) -->
  <main class="container mx-auto px-6 py-8 pt-24">

    <!-- ========== Langkah 1: Scan Kode Buku ========== -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-6 service-item">
      <div class="flex items-center mb-6">
        <div class="service-number rounded-full p-3 mr-4 text-white">
          <i class="fas fa-barcode text-2xl"></i>
        </div>
        <div>
          <h2 class="text-xl font-bold text-[#2F7A33]">Langkah 1: Scan Kode Buku</h2>
          <p class="text-gray-600 text-sm">Gunakan scanner barcode atau ketik manual</p>
        </div>
      </div>

      <form id="scanForm" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Kode Buku / Item Code</label>
          <div class="flex gap-3">
            <input 
              type="text" 
              id="itemCodeInput" 
              name="item_code"
              placeholder="Contoh: BK001234"
              class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2F7A33] focus:border-[#2F7A33] outline-none transition"
              autofocus
              required
            >
            <button 
              type="submit" 
              class="bg-[#2F7A33] hover:bg-[#256828] text-white px-8 py-3 rounded-lg font-semibold transition duration-200 flex items-center gap-2"
            >
              <i class="fas fa-search"></i>
              Cari Buku
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- ========== Langkah 2: Informasi Buku (Hidden by default) ========== -->
    <div id="bookInfoSection" class="bg-white rounded-xl shadow-lg p-8 mb-6 hidden service-item" style="animation: slideDown 0.4s ease-out;">
      <div class="flex items-center mb-6">
        <div class="bg-[#FFD700] rounded-full p-3 mr-4 text-[#2F7A33]">
          <i class="fas fa-book text-2xl"></i>
        </div>
        <div>
          <h2 class="text-xl font-bold text-[#2F7A33]">Langkah 2: Informasi Buku</h2>
          <p class="text-gray-600 text-sm">Buku ditemukan dan siap dipinjam</p>
        </div>
      </div>

      <div class="flex gap-6 flex-col md:flex-row">
        <div class="flex-shrink-0">
          <img 
            id="bookCover" 
            src="/images/buku.png" 
            alt="Cover Buku" 
            class="w-32 h-44 md:w-40 md:h-56 object-cover rounded-lg shadow-md border-2 border-gray-200"
          >
        </div>

        <div class="flex-1">
          <h3 id="bookTitle" class="text-2xl font-bold text-[#2F7A33] mb-2">-</h3>
          <div class="space-y-2 text-gray-700">
            <p><strong>Penulis:</strong> <span id="bookAuthor">-</span></p>
            <p><strong>Tahun Terbit:</strong> <span id="bookYear">-</span></p>
            <p><strong>Kode Buku:</strong> <span id="bookCode" class="font-mono bg-gray-100 px-2 py-1 rounded">-</span></p>
            
            <!-- Collation dengan parsing -->
            <div id="collationSection" class="hidden">
              <p><strong>Jumlah Halaman:</strong> <span id="bookPages">-</span></p>
              <p><strong>Ukuran Buku:</strong> <span id="bookSize">-</span></p>
            </div>
          </div>
          
          <button 
            id="btnOpenAuth" 
            class="mt-6 bg-[#FFD700] hover:bg-[#FFC107] text-[#2F7A33] px-6 py-3 rounded-lg font-semibold transition duration-200 flex items-center gap-2"
          >
            <i class="fas fa-user-check"></i>
            Lanjutkan Peminjaman
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- ========================== -->
  <!-- Modal: Autentikasi Peminjam -->
  <!-- ========================== -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="animation: fadeIn 0.3s ease-out;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
      <div class="bg-[#2F7A33] text-white p-6">
        <h3 class="text-xl font-bold flex items-center gap-2">
          <i class="fas fa-user-lock"></i> Autentikasi Peminjam
        </h3>
        <p class="text-green-100 text-sm mt-1">Masukkan NIM dan Password anggota</p>
      </div>

      <form id="authForm" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">NIM Anggota</label>
          <input 
            type="text" 
            id="borrowerNim" 
            placeholder="Contoh: 2311522033"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2F7A33] focus:border-[#2F7A33] outline-none transition"
            required
          >
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
          <input 
            type="password" 
            id="borrowerPassword" 
            placeholder="Password anggota"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2F7A33] focus:border-[#2F7A33] outline-none transition"
            required
          >
        </div>

        <div class="flex gap-3 pt-4">
          <button 
            type="button" 
            id="btnCancelAuth" 
            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-3 rounded-lg font-semibold transition duration-200"
          >
            Batal
          </button>
          <button 
            type="submit" 
            class="flex-1 bg-[#2F7A33] hover:bg-[#256828] text-white px-4 py-3 rounded-lg font-semibold transition duration-200 flex items-center justify-center gap-2"
          >
            <i class="fas fa-check-circle"></i>
            Proses Peminjaman
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Include Popup Partial -->
  <%- include('../partials/popup') %>

  <!-- JavaScript Logic -->
  <script src="/js/popup.js"></script>
  <script>
    // ============================================
    // Global State
    // ============================================
    let currentBookCode = null;
    let currentBookData = null;

    // ============================================
    // Elements
    // ============================================
    const scanForm = document.getElementById('scanForm');
    const itemCodeInput = document.getElementById('itemCodeInput');
    const bookInfoSection = document.getElementById('bookInfoSection');
    const btnOpenAuth = document.getElementById('btnOpenAuth');
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const btnCancelAuth = document.getElementById('btnCancelAuth');

    // ============================================
    // Helper: Parse Collation (seperti strukPinjam.ejs)
    // ============================================
    function parseCollation(collation) {
      if (!collation || collation === '-' || !collation.trim()) {
        return { pages: null, size: null };
      }

      const parts = collation.split(';').map(p => p.trim());
      let pages = null;
      let size = null;

      parts.forEach(part => {
        // Deteksi halaman: contoh "xii, 245 hal" atau "245 p."
        if (/\d+\s*(hal|hlm|p\.|pages)/i.test(part)) {
          const match = part.match(/(\d+)\s*(hal|hlm|p\.|pages)/i);
          if (match) {
            pages = match[1] + ' hal';
          }
        }
        // Deteksi ukuran: contoh "21 cm" atau "21x15 cm"
        else if (/\d+\s*(x\s*\d+)?\s*cm/i.test(part)) {
          const match = part.match(/(\d+\s*(x\s*\d+)?\s*cm)/i);
          if (match) {
            size = match[1];
          }
        }
      });

      return { pages, size };
    }

    // ============================================
    // Event: Scan / Cari Buku
    // ============================================
    scanForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const itemCode = itemCodeInput.value.trim();

      if (!itemCode) {
        if (typeof window.showPopup === 'function') {
          window.showPopup({
            type: 'warning',
            title: 'Input Kosong',
            message: 'Kode buku tidak boleh kosong.'
          });
        }
        return;
      }

      try {
        const response = await fetch('/inside/peminjaman/find', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_code: itemCode })
        });

        const data = await response.json();

        if (data.success) {
          // ✅ Buku ditemukan dan valid
          currentBookCode = data.book.item_code;
          currentBookData = data.book;
          displayBookInfo(data.book);
          bookInfoSection.classList.remove('hidden');
        } else {
          // ❌ Error dari server
          if (typeof window.showPopup === 'function') {
            window.showPopup({
              type: data.type || 'error',
              title: data.title || 'Gagal',
              message: data.message
            });
          }
          resetBookInfo();
        }
      } catch (err) {
        console.error('Error:', err);
        if (typeof window.showPopup === 'function') {
          window.showPopup({
            type: 'error',
            title: 'Kesalahan Server',
            message: 'Terjadi kesalahan saat mencari buku.'
          });
        }
      }
    });

    // ============================================
    // Event: Buka Modal Autentikasi
    // ============================================
    btnOpenAuth.addEventListener('click', () => {
      authModal.classList.remove('hidden');
      authModal.classList.add('flex');
      document.getElementById('borrowerNim').focus();
    });

    // ============================================
    // Event: Tutup Modal Autentikasi
    // ============================================
    btnCancelAuth.addEventListener('click', () => {
      authModal.classList.add('hidden');
      authModal.classList.remove('flex');
      authForm.reset();
    });

    // ============================================
    // Event: Submit Autentikasi & Proses Peminjaman
    // ============================================
    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const borrowerNim = document.getElementById('borrowerNim').value.trim();
      const borrowerPassword = document.getElementById('borrowerPassword').value;

      if (!borrowerNim || !borrowerPassword) {
        if (typeof window.showPopup === 'function') {
          window.showPopup({
            type: 'warning',
            title: 'Data Tidak Lengkap',
            message: 'NIM dan Password harus diisi.'
          });
        }
        return;
      }

      try {
        const response = await fetch('/inside/api/kiosk/borrow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            item_code: currentBookCode,
            borrower_id: borrowerNim,
            borrower_password: borrowerPassword
          })
        });

        const data = await response.json();

        if (data.success) {
          // ✅ Peminjaman berhasil
          authModal.classList.add('hidden');
          authModal.classList.remove('flex');
          authForm.reset();
          
          // Redirect ke halaman struk dengan data receipt
          const receiptData = encodeURIComponent(JSON.stringify(data.receipt));
          window.location.href = `/inside/strukPinjam?data=${receiptData}`;
        } else {
          // ❌ Gagal
          if (typeof window.showPopup === 'function') {
            window.showPopup({
              type: data.type || 'error',
              title: data.title || 'Gagal',
              message: data.message
            });
          }
        }
      } catch (err) {
        console.error('Error:', err);
        if (typeof window.showPopup === 'function') {
          window.showPopup({
            type: 'error',
            title: 'Kesalahan Server',
            message: 'Terjadi kesalahan saat memproses peminjaman.'
          });
        }
      }
    });

    // ============================================
    // Function: Display Book Info
    // ============================================
    function displayBookInfo(book) {
      document.getElementById('bookCover').src = book.cover || '/images/buku.png';
      document.getElementById('bookTitle').textContent = book.title || 'Judul tidak tersedia';
      document.getElementById('bookAuthor').textContent = book.author || 'Penulis tidak diketahui';
      document.getElementById('bookYear').textContent = book.publish_year || '-';
      document.getElementById('bookCode').textContent = book.item_code || '-';

      // Parse collation
      if (book.collation) {
        const parsed = parseCollation(book.collation);
        if (parsed.pages || parsed.size) {
          document.getElementById('collationSection').classList.remove('hidden');
          document.getElementById('bookPages').textContent = parsed.pages || '-';
          document.getElementById('bookSize').textContent = parsed.size || '-';
        } else {
          document.getElementById('collationSection').classList.add('hidden');
        }
      } else {
        document.getElementById('collationSection').classList.add('hidden');
      }
    }

    // ============================================
    // Function: Reset Book Info
    // ============================================
    function resetBookInfo() {
      currentBookCode = null;
      currentBookData = null;
      bookInfoSection.classList.add('hidden');
      document.getElementById('bookCover').src = '/images/buku.png';
      document.getElementById('bookTitle').textContent = '-';
      document.getElementById('bookAuthor').textContent = '-';
      document.getElementById('bookYear').textContent = '-';
      document.getElementById('bookCode').textContent = '-';
      document.getElementById('collationSection').classList.add('hidden');
    }

    // ============================================
    // Auto focus on page load
    // ============================================
    window.addEventListener('load', () => {
      itemCodeInput.focus();
    });
  </script>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</body>
</html>